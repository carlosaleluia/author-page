---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection, render } from 'astro:content';
import { getSortedBooks } from '../../lib/books';

export async function getStaticPaths() {
	const books = await getCollection('livros');

	return books.map((book) => ({
		params: { slug: book.id },
		props: { book },
	}));
}

const { book } = Astro.props;
const { Content } = await render(book);
const allBooks = await getSortedBooks();
const relatedBooks = allBooks.filter(b => b.id !== book.id);
---

<BaseLayout title={`${book.data.title} - Carlos Aleluia`}>
	<style>
		.back-link {
			display: inline-flex;
			align-items: center;
			justify-content: center;
			width: 40px;
			height: 40px;
			margin: 1.5rem 0;
			color: var(--text-secondary);
			text-decoration: none;
			border: 1px solid var(--border-color);
			border-radius: 50%;
			transition: color 0.2s, border-color 0.2s;
		}

		.back-link:hover {
			color: var(--text-primary);
			border-color: var(--text-primary);
		}

		.book-layout {
			display: flex;
			gap: 4rem;
			padding: 0 0 4rem;
		}

		/* Left sidebar — ~1/3 */
		.book-sidebar {
			flex: 0 0 33%;
			max-width: 33%;
			position: sticky;
			top: 6rem;
			align-self: flex-start;
		}

		.book-cover {
			width: 100%;
			aspect-ratio: 2/3;
			overflow: hidden;
			border-radius: 4px;
			background: var(--placeholder-bg);
		}

		.book-cover img {
			width: 100%;
			height: 100%;
			object-fit: cover;
			display: block;
		}

		.book-meta {
			color: var(--text-secondary);
			font-size: 0.85rem;
			text-transform: uppercase;
			letter-spacing: 1px;
			margin-top: 1rem;
		}

		.buy-section {
			margin-top: 2.5rem;
		}

		.buy-section h3 {
			font-size: 1rem;
			font-weight: 500;
			letter-spacing: 0.5px;
			text-transform: uppercase;
			color: var(--text-secondary);
			margin-bottom: 1rem;
		}

		.buy-links {
			display: flex;
			flex-direction: column;
			gap: 0.6rem;
		}

		.buy-link {
			display: block;
			padding: 0.75rem 2rem;
			border: 1px solid var(--border-color);
			color: var(--text-primary);
			text-decoration: none;
			font-size: 0.95rem;
			text-align: center;
			transition: all 0.2s;
			letter-spacing: 0.5px;
		}

		.buy-link:hover {
			background: var(--bg-hover);
			border-color: var(--text-primary);
		}

		.goodreads-link {
			display: inline-flex;
			align-items: center;
			gap: 0.5rem;
			margin-top: 2rem;
			color: var(--text-secondary);
			text-decoration: none;
			font-size: 0.95rem;
			transition: color 0.2s;
		}

		.goodreads-link:hover {
			color: var(--text-primary);
		}

		/* Right main — ~2/3 */
		.book-main {
			flex: 1;
			min-width: 0;
		}

		.book-main h1 {
			font-size: 3rem;
			font-weight: 300;
			letter-spacing: -1px;
			margin-top: -0.2em;
			margin-bottom: 0.5rem;
			line-height: 1.2;
		}

		.book-subtitle {
			font-size: 1.3rem;
			font-weight: 300;
			color: var(--text-secondary);
			margin-bottom: 1.5rem;
			line-height: 1.4;
		}

		.book-content {
			font-size: 1.1rem;
			line-height: 1.9;
			text-align: justify;
		}

		.book-content h2 {
			font-size: 1.8rem;
			font-weight: 400;
			margin: 3rem 0 1.5rem;
			letter-spacing: -0.5px;
		}

		.book-content h3 {
			font-size: 1.4rem;
			font-weight: 400;
			margin: 2.5rem 0 1rem;
		}

		.book-content p {
			margin-bottom: 1.5rem;
		}

		.book-content blockquote {
			border-left: 3px solid var(--border-color);
			padding-left: 2rem;
			margin: 2rem 0;
			font-style: italic;
			color: var(--text-secondary);
		}

		.book-content a {
			color: var(--text-primary);
			text-decoration: underline;
			text-underline-offset: 3px;
		}

		.book-content ul, .book-content ol {
			margin: 1.5rem 0;
			padding-left: 2rem;
		}

		.book-content li {
			margin-bottom: 0.75rem;
		}

		/* Related books section */
		.related-books {
			border-top: 1px solid var(--border-color);
			padding: 3rem 0;
			margin-top: 2rem;
		}

		.related-books h2 {
			font-size: 1.8rem;
			font-weight: 300;
			letter-spacing: -0.5px;
			margin-bottom: 2rem;
		}

		.related-grid {
			display: flex;
			gap: 2rem;
			overflow-x: auto;
		}

		.related-card {
			flex: 0 0 150px;
			text-decoration: none;
			color: var(--text-primary);
			text-align: center;
		}

		.related-cover {
			width: 150px;
			aspect-ratio: 2/3;
			overflow: hidden;
			border-radius: 4px;
			background: var(--placeholder-bg);
			margin-bottom: 0.75rem;
			transition: transform 0.2s, box-shadow 0.2s;
		}

		.related-card:hover .related-cover {
			transform: scale(1.03);
			box-shadow: 0 4px 20px rgba(0,0,0,0.1);
		}

		.related-cover img {
			width: 100%;
			height: 100%;
			object-fit: cover;
			display: block;
		}

		.related-card p {
			font-size: 0.95rem;
			line-height: 1.4;
		}

		@media (max-width: 768px) {
			.book-layout {
				flex-direction: column;
				gap: 2.5rem;
			}

			.book-sidebar {
				flex: none;
				max-width: 260px;
				position: static;
			}

			.book-main h1 {
				font-size: 2.5rem;
			}

			.book-content {
				font-size: 1.05rem;
			}

			.related-grid {
				gap: 1.5rem;
			}
		}
	</style>

	<div class="container">
		<a href="/livros" class="back-link" aria-label="Voltar aos livros">
			<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
		</a>

		<div class="book-layout">
			<aside class="book-sidebar">
				{book.data.coverImage && (
					<div class="book-cover">
						<img src={book.data.coverImage} alt={book.data.title} />
					</div>
				)}
				<p class="book-meta">
					{book.data.pubDate.toLocaleDateString('pt-PT', {
						year: 'numeric',
						month: 'long'
					})}
				</p>
				{book.data.buyLinks && book.data.buyLinks.length > 0 && (
					<div class="buy-section">
						<h3>Compra o livro</h3>
						<div class="buy-links">
							{book.data.buyLinks.map((link) => (
								<a href={link.url} target="_blank" rel="noopener noreferrer" class="buy-link">{link.label}</a>
							))}
						</div>
					</div>
				)}
			</aside>

			<div class="book-main">
				<h1>{book.data.title}</h1>
				{book.data.subtitle && (
					<p class="book-subtitle">{book.data.subtitle}</p>
				)}
				<article class="book-content">
					<Content />
				</article>
				{book.data.goodreadsUrl && (
					<a href={book.data.goodreadsUrl} target="_blank" rel="noopener noreferrer" class="goodreads-link">
						<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M11.43 23.995c-3.608-.208-6.274-2.077-6.448-5.078.695.007 1.375-.013 2.07-.006.224 1.342 1.065 2.43 2.683 3.026 1.583.496 3.737.46 5.082-.174 1.527-.718 2.279-1.96 2.604-3.589.158-.748.2-1.58.202-2.37l-.037-.186c-.555.91-1.275 1.633-2.166 2.124-1.537.848-3.7.986-5.577.384-2.551-.819-3.977-2.845-4.453-5.291-.263-1.355-.2-2.813.133-4.145.576-2.3 2.09-4.025 4.235-4.87 1.768-.695 3.726-.678 5.225.165.776.435 1.325 1.01 1.783 1.676l.054-.015.015-1.554h1.96l-.013 12.298c-.007 1.15-.098 2.144-.378 3.123-.726 2.532-2.603 4.2-5.482 4.552-.488.06-.984.088-1.492.09v-.16zm2.601-7.736c1.09-.527 1.81-1.42 2.182-2.56.373-1.138.378-2.442.183-3.602-.236-1.406-.73-2.588-1.774-3.39-.847-.651-2.06-.898-3.182-.746-1.478.2-2.482 1.048-3.06 2.293-.474 1.023-.635 2.26-.534 3.473.105 1.267.44 2.418 1.2 3.345.718.877 1.742 1.36 2.988 1.37 1.114-.003 1.912-.28 2.007-.183h-.01z"/></svg>
						Goodreads
					</a>
				)}
			</div>
		</div>

		{relatedBooks.length > 0 && (
			<section class="related-books">
				<h2>Outros livros</h2>
				<div class="related-grid">
					{relatedBooks.map(b => (
						<a href={`/livros/${b.id}`} class="related-card">
							<div class="related-cover">
								{b.data.coverImage && <img src={b.data.coverImage} alt={b.data.title} loading="lazy" />}
							</div>
							<p>{b.data.title}</p>
						</a>
					))}
				</div>
			</section>
		)}
	</div>
</BaseLayout>